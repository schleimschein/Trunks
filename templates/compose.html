{% extends "base.html" %}
{% set comma = joiner(",") %}


{% block title %} New Post {% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/bulma-switch.min.css') }}" media="all">
<link rel="stylesheet" href="{{ url_for('static', filename='css/tagify_bulma_flavoured.css') }}" media="all">
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" media="all">


{% endblock %}

{% block sidebar %}
<div class="content">
    <div class="panel">
        <div class="panel-heading">
            Options
        </div>

        <a class="panel-block" href="#save-as-draft" id="action-draft">
            <span class="panel-icon">
                <i class="fa fa-book"></i>
            </span>
            Save as Draft
        </a>

        <a class="panel-block" href="#delete" id="action-delete-post">
            <span class="panel-icon">
                <i class="fa fa-minus"></i>
            </span>
            Delete Post
        </a>

        <a class="panel-block" href="#view-preview" id="action-preview">
            <span class="panel-icon">
                <i class="fa fa-eye"></i>
            </span>
            Preview
        </a>

    </div>
</div>
{% endblock %}

{% block body %}
    <div class="post-form-container content">
        <form action="{{ url_for('admin_save_post') }}" method="POST" id="post-form">
            <label class="label">Post Title</label>
            <p class="control">
                {% if not editing %}
                <input type="text" name="post-title" class="input" placeholder="No Title">
                {% else %}
                <input type="text" name="post-title" class="input" placeholder="No Title" value="{{ post.title }}">
                {% endif %}
            </p>
            <label class="label">Short Description</label>
            <p class="control">
                <textarea style="height:6em" class="input" name="post-description" id="post-description-editor">{% if editing %}{{ post.description }}{% endif %}</textarea>
            </p>
            <label class="label">Content</label>
            <p class="control">
              <textarea name="post-content" id="post-content-editor">{% if editing %}{{ post.content }}{% endif %}</textarea>
            </p>
            <label class="label">Tags</label>
            <p class="control">
                {% if not editing %}
                <input class="input" id="input_tagify" type="tags" name="post-tags" placeholder="Tags" value="{% for tag in tags_of_post %}{{ comma() }}{{tag.name}}{% endfor %}">
                {% else %}
                <input class="input" id="input_tagify" type="tags" name="post-tags" placeholder="Tags" value="{% for tag in tags_of_post %}{{ comma() }}{{tag.name}}{% endfor %}">
                {% endif %}
                <div id="all-tags" all-tags="{% for tag in all_tags %}{{ comma() }}{{tag.name}}{% endfor %}"></div>

            </p>
            <label class="label"> Status</label>
            <p class="control">
            {% if not editing %}
              <input class="switch is-primary " id="post-publish-switch" type="checkbox" name="post-publish" checked="checked">
            {% else %}
              <input class="switch is-primary" id="post-publish-switch" type="checkbox" name="post-publish" {% if post.published %} checked="checked" {% endif %}>
            {% endif %}
              <label class="label" id="post-publish-switch-label" for="post-publish-switch">Publish</label>
            </p>

            {% if editing %}
                <input type="hidden" name="post-edit-id" value="{{ post.id }}">
            {% endif %}

            <div class="has-text-right"><button id="post-submit-button" class="button is-primary is-large">Post</button></div>
        </form>
    </div>


    <div id="preview" style="display:none;margin-top:2.64em;" >
      <h2 style="text-decoration:none;">Preview:</h2>
      <div class="box blog-post-card" id="preview-box">



      <h1 class="preview post-heading"></h1>
      <h5>Posted by {{ current_user.name }} on <span id="current_date_and_time"></span> </h5>

      <div class="preview post-content">
      </div>
<!--
          <nav class="level tag-bar">
              <div class="level-left">

                  <span class="icon is-small level-item">
                      <i class="fa fa-tags"></i>
                  </span>

              </div>

              <div class="level-right">
                  {% for tag in tags %}
                  <a class="level-item tag is-info post-tag">
                      {{ tag.name }}
                  </a>
                  {% endfor %}
              </div>
          </nav>
-->
    </div>
  </div>
{% endblock %}

{% block javascript %}
<script src="{{ url_for('static', filename='js/tagify.js') }}"></script>


<script type="text/javascript">



$(function() {

    var input = document.querySelector('input[id=input_tagify]');
    var all_tags = document.getElementById("all-tags").getAttribute("all-tags");
    var tagify = new Tagify(input, {
      whitelist: all_tags.split(','),
      autocomplete: false,
      tagTemplate: function template(v, tagData) {
        return "<tag title='" + v + "' contenteditable='false' spellcheck=\"false\">\n                            <div><span class='tagify__tag-text'>" + v + "</span></div><x class='delete is-small' title=''></x>\n                        </tag>";
      }
    });

    var postForm = document.getElementById('post-form');
    var postEditor = new SimpleMDE({ element: document.getElementById("post-content-editor")});
    var postPublishSwitch = document.getElementById('post-publish-switch');
    var postPublishSwitchLabel = document.getElementById('post-publish-switch-label');
    var postSubmitButton = document.getElementById('post-submit-button');

    $("#action-draft").click(function(e) {
        postPublishSwitch.checked = false;
        postForm.submit();
    });

    $("#action-preview").click(function(e) {
        postData = { }
        postData.post_title = $("[name='post-title']").val();
        postData.post_content_as_markdown = postEditor.value();

        $.post("{{ url_for('preview') }}", postData).done(function(data) {
            let post_content_as_html = data['html'], date_time = data['date_time'];
            $(".preview.post-heading").html(postData.post_title);
            $("#current_date_and_time").html(date_time);
            $(".preview.post-content").html(post_content_as_html);
            $("#preview").show();
            $("#preview-box")[0].scrollIntoView();
        });
    });

    $("#action-delete-post").click(function(e) {
        var editId = $('[name="post-edit-id"]').val();
        if(confirm("Are you sure you want to delete post " + editId + "?"))
        {
            $.post("{{ url_for('admin_post_delete') }}", { id: editId, was_edit: true }).done(function(e) {
              if(JSON.parse(e)["ok"] === true) {
                window.location = "{{ url_for('admin_post_list') }}";
              }
              else
              {
                location.reload();
              }
            });
        }
    });

    $("#post-publish-switch").click(function(e) {
        postSubmitButton.innerHTML = postPublishSwitch.checked ? "Post" : "Save";
        postPublishSwitchLabel.innerHTML = postPublishSwitch.checked ? "Publish" : "Draft";
    });



});


</script>
{% endblock %}
